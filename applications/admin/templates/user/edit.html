{% extends "../base.html" %}

{% block title %} {% end %}
{% block css %} {% end %}
{% block body %}
    {% include user_form.html %}
 {% end %}

{% block javascript %}
<script src="{{ static_url("js/jsencrypt.js") }}" charset="utf-8"></script>
<script type="text/javascript">
var public_key = '{{ public_key.replace('\n', '')[26:-24] }}'
var formData = {% raw data_info %};
layui.use(['form'], function() {
    var $ = layui.jquery, form = layui.form

    form.on('checkbox(userPermission)', function(data) {
        var child = $(data.elem).parent('dt').siblings('dd').find('input')
        /* 自动选中父节点 */
        var check_parent = function (id) {
            var self = $('.role-list-form input[value="'+id+'"]')
            var pid = self.attr('data-pid') || '';
            self.prop('checked', true)
            if (pid == '') {
                return false;
            }
            check_parent(pid)
        };
        /* 自动选中子节点 */
        child.each(function(index, item) {
            item.checked = data.elem.checked;
        })
        check_parent($(data.elem).attr('data-pid'))
        form.render('checkbox')
    })

    /* 权限赋值 */
    if (formData) {
        for(var i in formData['permission']) {
            $('.role-list-form input[value="'+formData['permission'][i]+'"]').prop('checked', true)
        }
        form.render('checkbox')
    }

    // 表单验证
    form.verify({
        username : [/[A-Za-z0-9\u4e00-\u9fa5]{2,40}$/, '用户名必须2到40位字母、数字组合或汉字'],
        // password : [/(.+){8,40}$/, '密码必须8到40位'],
        number : [/^[0-9]*$/, '必须输入数字啊']
    })
    form.on('submit(formSubmit)', function(obj) {
        layer.msg('数据提交中...',{time:50000})

        // Encrypt with the public key...
        var encrypt = new JSEncrypt()
        encrypt.setPublicKey(public_key)

        var ciphertext = encrypt.encrypt(obj.field.password)
        obj.field.password = ciphertext

        var permission = []
        $("input:checkbox[name='permission']:checked").each(function() {
            permission.push($(this).val())
        });
        obj.field.permission = permission

        $.ajax({
            type: "POST",
            url: obj.form.action,
            data: obj.field,
            success: function(res) {
                if (res.code==0) {
                    layer.msg('更新成功', {icon: 1, time: 2000}, function(){
                        parent.edit_success(res.data)
                        var index = parent.layer.getFrameIndex(window.name);
                        parent.layer.close(index);
                    })
                } else if(res.msg) {
                    layer.msg(res.msg)
                    $(":input[name='username']").focus()
                } else {
                    layer.msg('{{ _('未知错误') }}')
                }
            },
            error: function(xhr){
                console.log(xhr.responseJSON)
                if (xhr.responseJSON && xhr.responseJSON.msg) {
                    layer.msg(xhr.responseJSON.msg)
                } else {
                    layer.msg('{{ _('未知错误') }}')
                }
            }
        })
        return false;
    })
})
</script>
<script src="{{ static_url("admin/js/footer.js") }}" charset="utf-8"></script>
 {% end %}
